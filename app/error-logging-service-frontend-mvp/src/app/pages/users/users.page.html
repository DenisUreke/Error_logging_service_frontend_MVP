<div class="parent-container">

    <!-- Top controls -->
    <div class="header">
        <div class="actions">
            <div class="actions-right">
                <!-- Machine -->
                <select class="select" [(ngModel)]="selectedMachine" (ngModelChange)="onMachineChanged()">
                    <option *ngFor="let m of machineOptions" [value]="m">{{ m }}</option>
                </select>

                <!-- Add user -->
                <select class="select" [(ngModel)]="selectedUserIdToAdd"
                    [disabled]="selectedMachine === 'Select machine...' || usersLoading">
                    <option [ngValue]="null">Add user…</option>
                    <option *ngFor="let u of allUsers" [ngValue]="u.id">
                        {{ u.first_name }} {{ u.last_name }} ({{ u.role || '—' }})
                    </option>
                </select>

                <button class="tool-button" (click)="addSelectedUserToMachine()"
                    [disabled]="!selectedUserIdToAdd || selectedMachine === 'Select machine...' || usersLoading">
                    Add
                </button>
            </div>

            <div class="actions-left">
                <div class="muted" *ngIf="message">{{ message }}</div>
            </div>
        </div>
    </div>

    <!-- 3-window layout -->
    <div class="layout">

        <!-- 1: General rules (full width) -->
        <div class="panel panel-general">
            <div class="panel-title">
                General rules ({{ selectedMachine }})
            </div>

            <div class="general-grid">
                <label class="check">
                    <input type="checkbox" [(ngModel)]="general.enabled" />
                    <span>Enabled</span>
                </label>

                <label class="field">
                    <span class="field-label">Minimum severity</span>
                    <select class="select" [(ngModel)]="general.minSeverity">
                        <option value="INFO">INFO</option>
                        <option value="WARN">WARN</option>
                        <option value="ERROR">ERROR</option>
                        <option value="CRITICAL">CRITICAL</option>
                    </select>
                </label>

                <label class="check">
                    <input type="checkbox" [(ngModel)]="general.doHaloTicket" />
                    <span>Create Halo ticket</span>
                </label>

                <label class="check">
                    <input type="checkbox" [(ngModel)]="general.doCall" />
                    <span>Call all</span>
                </label>

                <label class="check">
                    <input type="checkbox" [(ngModel)]="general.doEmail" />
                    <span>Email all</span>
                </label>
            </div>
        </div>

        <!-- 2: User list (bottom-left) -->
        <div class="panel panel-users">
            <div class="panel-title">Users</div>

            <div class="muted" *ngIf="!rulesRows.length && selectedMachine === 'Select machine...'">
                Select a machine to load users.
            </div>

            <div class="muted" *ngIf="!rulesRows.length && selectedMachine !== 'Select machine...' && !loading">
                <div class="muted" *ngIf="loading">
                    Loading...
                </div>

                No users found for this machine.
            </div>


            <!-- placeholder list area -->
            <div class="list-scroll" *ngIf="rulesRows.length">
                <div class="user-row" *ngFor="let u of rulesRows" (click)="selectUser(u)"
                    [class.user-row--active]="selectedRow?.user_id === u.user_id">
                    <div class="user-name">{{ u.first_name }} {{ u.last_name }}</div>
                    <div class="muted">{{ u.email }}</div>
                    <div class="muted">{{ u.phone_number }}</div>
                </div>
            </div>
        </div>

        <!-- 3: Rule editor (bottom-right) -->
        <div class="panel panel-editor">
            <div class="panel-title">Rule editor</div>

            <div class="muted" *ngIf="!selectedRow">
                Click a user to edit.
            </div>

            <div *ngIf="selectedRow" class="editor">
                <div class="editor-header">
                    <div class="editor-name">
                        {{ selectedRow.first_name }} {{ selectedRow.last_name }}
                    </div>
                    <div class="muted">{{ selectedRow.email }}</div>
                    <div class="muted">{{ selectedRow.phone_number }}</div>
                </div>

                <div class="editor-grid">
                    <label class="check">
                        <input type="checkbox" [(ngModel)]="selectedRow.enabled" />
                        <span>Enabled</span>
                    </label>

                    <label class="field">
                        <span class="field-label">Minimum severity</span>
                        <select class="select" [(ngModel)]="selectedRow.min_severity">
                            <option value="INFO">INFO</option>
                            <option value="WARN">WARN</option>
                            <option value="ERROR">ERROR</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                    </label>

                    <label class="check">
                        <input type="checkbox" [(ngModel)]="selectedRow.do_halo_ticket" />
                        <span>Create Halo ticket</span>
                    </label>

                    <label class="check">
                        <input type="checkbox" [(ngModel)]="selectedRow.do_call" />
                        <span>Call</span>
                    </label>

                    <label class="check">
                        <input type="checkbox" [(ngModel)]="selectedRow.do_email" />
                        <span>Email</span>
                    </label>
                </div>
            </div>

            <div class="spacer"></div>
            <div class="editor-actions">
                <button class="tool-button" (click)="saveChanges()"
                    [disabled]="!selectedRow || saving || selectedMachine === 'Select machine...'">
                    {{ saving ? 'Saving...' : 'Save Changes' }}
                </button>
                <button class="tool-button_delete" (click)="deleteSelectedRule()"
                    [disabled]="!selectedRow || saving || selectedMachine === 'Select machine...'">
                    {{ saving ? 'Deleting...' : 'Delete Rule' }}
                </button>
            </div>

        </div>


    </div>
</div>